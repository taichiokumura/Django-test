<!DOCTYPE html>
{% load static %}
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Position Display</title>
    <link rel="stylesheet" href="{% static 'css/reset.css' %}">
    <link rel="stylesheet" href="{% static 'css/determine_position.css' %}">
</head>
<body>
    <h1>位置決定された画像</h1>
    <div id="container">
        <img id="baseImage" class="image" src="{% static 'media/river_sample.jpg' %}" alt="Base Image">
        {% for position in positions %}
            <img class="overlayImage" src="{{ position.image_url }}" data-x="{{ position.x }}" data-y="{{ position.y }}" data-card-info-id="{{ position.card_info_unique_id }}">
        {% endfor %}
    </div>

    <div id="cardInfoModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>カード情報</h2>
            <div id="cardInfoContent"></div>
        </div>
    </div>

    <script>
        window.onload = function() {
            const baseImage = document.getElementById('baseImage');
            const overlayImages = document.querySelectorAll('.overlayImage');
            const modal = document.getElementById('cardInfoModal');
            const span = document.getElementsByClassName('close')[0];
            const cardInfoContent = document.getElementById('cardInfoContent');

            // モーダルを閉じる
            span.onclick = function() {
                modal.classList.remove('show');
            }

            // baseImageの中央を取得
            const baseRect = baseImage.getBoundingClientRect();
            const baseCenterX = baseRect.width / 2;
            const baseCenterY = baseRect.height / 2;

            console.log('Base Center - x:', baseCenterX, 'y:', baseCenterY);

            overlayImages.forEach(function (overlayImage) {
                const x = parseFloat(overlayImage.getAttribute('data-x'));
                const y = parseFloat(overlayImage.getAttribute('data-y'));
                const cardInfoId = overlayImage.getAttribute('data-card-info-id');

                console.log('Initial Position - x:', x, 'y:', y, 'card_info_id:', cardInfoId);

                // overlayImageの初期位置をbaseImageの中央に設定
                overlayImage.style.position = 'absolute';
                overlayImage.style.left = `${baseCenterX - overlayImage.width / 2}px`;
                overlayImage.style.top = `${baseCenterY - overlayImage.height / 2}px`;

                // オフセットを適用
                overlayImage.style.transform = `translate(${x}px, ${y}px)`;

                // 位置が正しく適用されたかどうかを確認
                console.log('Overlay Image Position - left:', overlayImage.style.left, 'top:', overlayImage.style.top);

                // クリックイベント
                overlayImage.addEventListener('click', function() {
                    const url = `/get_card_info/${cardInfoId}/`;
                    console.log(`Fetching card info from URL: ${url}`);

                    fetch(url)
                        .then(response => {
                            if (!response.ok) {
                                throw new Error(`HTTP error! status: ${response.status}`);
                            }
                            return response.json();
                        })
                        .then(data => {
                            if (data.status === 'failure') {
                                console.error(data.error);
                                return;
                            }

                            cardInfoContent.innerHTML = ''; // モーダル内容をクリア

                            data.data.forEach(card => {
                                const cardHtml =  `
                                    <img src="${card.photo}" alt="Card Photo">
                                    <img src="${card.observation_date_images}" alt="Observation Date Images">
                                    <img src="${card.observation_place_images_1}" alt="Observation Place Images 1">
                                    <img src="${card.observation_place_images_2}" alt="Observation Place Images 2">
                                    <img src="${card.river_state_images}" alt="River State Images">
                                    <img src="${card.living_thing_consideration_images}" alt="Living Thing Consideration Images">
                                `;
                                cardInfoContent.insertAdjacentHTML('beforeend', cardHtml);
                            });

                            modal.classList.add('show');
                        })
                        .catch(error => console.error('Error fetching card info:', error));
                });
            });
        }
    </script>
</body>
</html>






